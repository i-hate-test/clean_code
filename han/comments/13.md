# Chapter 13 동시성
## 동시성이 필요한 이유
### 어플리케이션의 구조적 개선
동시성은 **무엇**과 **언제**의 결합을 분리하는 전략이다. 동시성을 갖춘 어플리케이션은 작은 프로그램이 협력하고 있는 덩어리로 보여서 시스템을 이해하고 문제를 해결하기 쉽다.
### 어플리케이션의 효율 개선
당연한 얘기다. 하지만 그렇다고해서 성능이 반드시 개선되는 것은 아니다.

## 동시성 구현이 가져오는 어려움을 방어하는 전략
### 1. SRP
동시성 코드를 일반 코드와 분리하라
### 2. 자료 범위를 제한하라
공유 자료, 임계 영역을 최대한 줄여라. synchronized 키워드로 보호하라.
### 3. 자료 사본을 이용하라
복사 시간과 부하가 주는 부담이 있을 수 있지만 동시성 코드가 가져올 문제를 예방할 수 있다. \
때로는 복사에 드는 비용을 실측할 필요도 있다. 모든 것은 trade-off 다.
### 4. 스레드는 가능한 독립적으로 구현하라
### 5. 라이브러리를 이해하라
### 6. 실행 모델을 이해하라
#### Producer-Consumer 생산자-소비자
생산자 스레드가 정보를 생성하여 버퍼나 queue 대기열에 넣는다. 소비자 스레드는 해당 버퍼나 대기열로부터 정보를 가져온다. \
생산자는 정보 생성 후 소비자에게 소비할 정보가 있다는 시그널을 보낸다. 소비자는 빈 대기열을 확인한 경우 생산자에게 생산이 가능하다는 시그널을 보낸다. \
잘못하면 둘 다 시그널을 기다리는 문제 상황이 발생할 수 있다.
#### Readers-Writers 읽기-쓰기
쓰기가 정보를 오래 점유하면서 읽기가 오래 대기하면 처리율이 떨어진다. \
처리율 향상을 위해 점유 시간이 짧은 읽기의 우선순위를 높이면 기아 상태에 빠지는 스레드가 발생한다. \
이 둘 사이의 조율이 중요한 모델이다.
#### Dining Philosophers 식사하는 철학자들
공유자원을 두고 여러 스레드가 경쟁하는 모델
### 7. 동기화하는 메서드 사이에 존재하는 의존성을 이해하라
공유 객체에는 되도록 동기화 메서드를 하나만 두는 것이 좋다. 
### 8. 동기화하는 부분을 작게 만들어라
### 9. 올바른 종료를 보장하라
데드락 상태처럼 종료가 올바르게 이루어지지 않는 상황에 대응하라. \ 
종료 코드를 개발 초기부터 고민하라.

### 10. 스레드 코드 테스트하기
1. 일회성 문제는 없다. 잠정적인 스레드 문제로 취급하자
2. 싱글 스레드에서의 순차 코드부터 제대로 돌게 하자
3. 다양한 환경에 쉽게 끼워 넣을 수 있는 스레드 코드를 구현하라
4. 스레드 개수를 조율하기 쉬운 코드를 구현하라
5. 프로세서 수보다 많은 스레드를 돌려보라.
6. 다른 플랫폼에서 돌려보라
7. 보조 코드를 사용하라. 강제로 실패를 일으켜라 
   다중 스레드 환경으로부터 기인한 에러는 간혹, 랜덤하게 등장한다. 코드가 실행되는 수천 가지 경로 중에 아주 소수만 실패하기 때문이다. \
   실패를 강제로 일으키는 코드를 작성하면 실패를 재현할 수 있다. 실패를 일으키는 방법으로는 **흔들기(jiggle)** 기법이 있다.
